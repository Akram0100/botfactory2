{% extends "base.html" %}

{% block title %}Botlarim - BotFactory AI{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="flex justify-between items-center" style="margin-bottom: 2rem;">
        <div>
            <h1>Botlarim</h1>
            <p style="margin: 0;">AI chatbotlaringizni boshqaring</p>
        </div>
        <button onclick="UI.showModal('createBotModal')" class="btn btn-primary">
            <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Yangi bot yaratish
        </button>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="empty-state">
        <div class="spinner"></div>
        <p>Yuklanmoqda...</p>
    </div>

    <!-- Bots Container (loaded via JS) -->
    <div id="botsContainer" style="display: none;"></div>
</div>

<!-- Create Bot Modal -->
<div class="modal-overlay" id="createBotModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Yangi bot yaratish</h3>
            <button class="modal-close" onclick="UI.hideModal('createBotModal')">âœ•</button>
        </div>
        <form id="createBotForm">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Bot nomi *</label>
                    <input type="text" name="name" class="form-input" placeholder="Mening botim" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Platforma *</label>
                    <select name="platform" class="form-input" required>
                        <option value="telegram">Telegram</option>
                        <option value="whatsapp" disabled>WhatsApp (tez kunda)</option>
                        <option value="instagram" disabled>Instagram (tez kunda)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Bot token *</label>
                    <input type="text" name="token" class="form-input" placeholder="123456:ABC-DEF..." required>
                    <small style="color: var(--text-muted);">
                        Telegram: @BotFather dan oling
                    </small>
                </div>

                <div class="form-group">
                    <label class="form-label">Tavsif</label>
                    <textarea name="description" class="form-input" placeholder="Bot haqida qisqacha..."></textarea>
                </div>

                <div id="createBotError" class="alert alert-danger" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="UI.hideModal('createBotModal')">Bekor
                    qilish</button>
                <button type="submit" class="btn btn-primary">Yaratish</button>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
    // Load bots from API
    async function loadBots() {
        if (!Auth.isLoggedIn()) {
            window.location.href = '/login';
            return;
        }

        try {
            const result = await api.get('/bots');
            const bots = result.ok ? (result.data.items || result.data || []) : [];

            const container = document.getElementById('botsContainer');

            if (bots.length > 0) {
                container.innerHTML = `
                    <div class="grid grid-cols-3 gap-4">
                        ${bots.map(bot => `
                            <div class="bot-card" data-bot-id="${bot.id}">
                                <div class="bot-header">
                                    <div class="bot-avatar">ðŸ¤–</div>
                                    <div class="bot-info">
                                        <h3 style="margin: 0;">${bot.name}</h3>
                                        <span class="bot-platform">
                                            ðŸ“± ${(bot.platform || 'telegram').charAt(0).toUpperCase() + (bot.platform || 'telegram').slice(1)}
                                        </span>
                                    </div>
                                    <span class="badge ${bot.is_active ? 'badge-success' : 'badge-warning'}" style="margin-left: auto;">
                                        ${bot.is_active ? 'Faol' : 'Nofaol'}
                                    </span>
                                </div>

                                <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 1rem 0;">
                                    ${bot.description || "Tavsif yo'q"}
                                </p>

                                <div class="bot-stats">
                                    <div class="bot-stat">
                                        <div class="bot-stat-value">${bot.total_messages || 0}</div>
                                        <div class="bot-stat-label">Xabarlar</div>
                                    </div>
                                    <div class="bot-stat">
                                        <div class="bot-stat-value">${bot.total_users || 0}</div>
                                        <div class="bot-stat-label">Foydalanuvchilar</div>
                                    </div>
                                </div>

                                <div style="display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                    <a href="/bots/${bot.id}" class="btn btn-secondary btn-sm" style="flex: 1;">
                                        Sozlamalar
                                    </a>
                                    <button onclick="toggleBot(${bot.id}, ${!bot.is_active})" class="btn ${bot.is_active ? 'btn-danger' : 'btn-success'} btn-sm">
                                        ${bot.is_active ? "O'chirish" : 'Yoqish'}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            <h3>Hali botlar yo'q</h3>
                            <p>Birinchi AI chatbotingizni yarating va biznesingizni avtomatlashiring!</p>
                            <button onclick="UI.showModal('createBotModal')" class="btn btn-primary">Bot yaratish</button>
                        </div>
                    </div>
                `;
            }

            document.getElementById('loadingState').style.display = 'none';
            container.style.display = 'block';

        } catch (error) {
            console.error('Error loading bots:', error);
            document.getElementById('loadingState').innerHTML = '<p>Xatolik yuz berdi</p>';
        }
    }

    // Create bot form
    document.getElementById('createBotForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        const errorDiv = document.getElementById('createBotError');
        errorDiv.style.display = 'none';

        const result = await api.post('/bots', data);

        if (result.ok) {
            UI.hideModal('createBotModal');
            UI.showAlert('Bot muvaffaqiyatli yaratildi!', 'success');
            loadBots(); // Reload bots list
        } else {
            errorDiv.textContent = result.data?.detail || 'Xatolik yuz berdi';
            errorDiv.style.display = 'block';
        }
    });

    // Toggle bot status
    async function toggleBot(botId, activate) {
        const endpoint = activate ? `/bots/${botId}/activate` : `/bots/${botId}/deactivate`;
        const result = await api.post(endpoint);

        if (result.ok) {
            UI.showAlert(activate ? 'Bot yoqildi!' : "Bot o'chirildi!", 'success');
            loadBots(); // Reload bots list
        } else {
            UI.showAlert(result.data?.detail || 'Xatolik yuz berdi', 'danger');
        }
    }

    // Load bots on page load
    document.addEventListener('DOMContentLoaded', loadBots);
</script>
{% endblock %}
{% endblock %}